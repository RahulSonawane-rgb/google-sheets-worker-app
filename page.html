<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WorkerSync</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Roboto:wght@400;500&family=Noto+Sans:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #6B2D2D; /* Burgundy */
            --secondary-color: #1A5F3C; /* Forest green */
            --accent-color: #D4A017; /* Antique gold */
            --background-color: #F9F5F0; /* Off-white */
            --card-bg: linear-gradient(135deg, #FFFFFF, #F2ECE4); /* White to parchment */
            --text-color: #2A2A2A; /* Dark gray */
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --modal-bg: rgba(0, 0, 0, 0.6);
            --border-color: #B8972E; /* Soft bronze */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', 'Noto Sans', sans-serif;
        }

        html, body {
            width: 100%;
            max-width: 100vw;
            min-height: 100vh;
            overflow-x: hidden;
            background: var(--background-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 2vw;
        }

        h1, h2, h3, h4 {
            font-family: 'Playfair Display', serif;
            color: var(--primary-color);
        }

        h1 {
            font-size: 5vw;
            text-align: center;
            margin-bottom: 3vw;
            font-weight: 600;
        }

        .section {
            background: var(--card-bg);
            padding: 3vw;
            border-radius: 1.5vw;
            margin-bottom: 3vw;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            animation: fadeIn 0.4s ease;
            position: relative;
            z-index: 1;
        }

        .form-group {
            margin-bottom: 2.5vw;
        }

        label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-color);
            display: block;
            margin-bottom: 1.5vw;
        }

        input, select {
            width: 100%;
            padding: 2vw;
            border: 1px solid var(--border-color);
            border-radius: 1vw;
            font-size: 0.9rem;
            background: #fff;
            box-shadow: inset 0 0.2vw 0.6vw rgba(0, 0, 0, 0.05);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            font-family: 'Noto Sans', sans-serif;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.4vw rgba(26, 95, 60, 0.2);
        }

        button {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 2vw 4vw;
            border: none;
            border-radius: 1vw;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 1.5vw;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.3s ease;
            position: relative;
            z-index: 2;
            pointer-events: auto;
        }

        button i {
            font-size: 0.9rem;
            color: var(--accent-color);
        }

        button:hover:not(.loading) {
            transform: translateY(-0.2vw);
            box-shadow: 0 0.8vw 2.4vw rgba(0, 0, 0, 0.15);
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
        }

        button.loading {
            cursor: not-allowed;
            opacity: 0.7;
            animation: pulse 1.5s infinite;
            position: relative;
            overflow: hidden;
        }

        button.loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent 25%, rgba(255, 255, 255, 0.4) 50%, transparent 75%);
            animation: loadingShine 1.5s infinite;
        }

        .edit-btn, .delete-btn {
            padding: 1vw 2vw;
            font-size: 0.8rem;
            line-height: 1;
        }

        .edit-btn i, .delete-btn i {
            font-size: 0.8rem;
            margin-right: 0;
        }

        .tabcontent {
            display: none;
            flex: 1;
        }

        .tabcontent.active {
            display: block;
        }

        .tab {
            display: none;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            box-shadow: 0 -0.4vw 1.2vw rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-around;
            padding: 2vw 0;
            z-index: 1000;
            border-top: 1px solid var(--border-color);
        }

        .bottom-nav button {
            background: none;
            color: var(--text-color);
            padding: 2vw;
            font-size: 0.8rem;
            font-weight: 500;
            flex: 1;
            text-align: center;
            border-radius: 0;
            z-index: 2;
            pointer-events: auto;
        }

        .bottom-nav button.active {
            color: var(--accent-color);
            background: rgba(107, 45, 45, 0.1);
        }

        .bottom-nav button i {
            display: block;
            font-size: 1.3rem;
            margin-bottom: 0.8vw;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border-radius: 1.5vw;
            overflow: hidden;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        th, td {
            padding: 2vw;
            text-align: left;
            font-size: 0.9rem;
            font-family: 'Noto Sans', sans-serif;
        }

        th {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            font-weight: 500;
            font-family: 'Playfair Display', serif;
        }

        tr:nth-child(even) {
            background: rgba(242, 236, 228, 0.5);
        }

        tr:hover {
            background: rgba(107, 45, 45, 0.05);
            transition: background 0.2s ease;
        }

        /* Pay Report Section - Default Size */
        #payReport {
            background: #fff;
            border: 1px solid #ccc;
            box-shadow: none;
            border-radius: 0.5vw;
        }

        #payReport th, #payReport td {
            padding: 3vw;
            font-size: 1rem;
        }

        #payReport tr:nth-child(even) {
            background: #f9f9f9;
        }

        #payReport tr:hover {
            background: #f1f1f1;
        }

        /* Attendance History - Grouped Styling */
        #attendanceHistory .date-row {
            font-weight: bold;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        #attendanceHistory .date-row td {
            padding: 2vw;
            font-family: 'Playfair Display', serif;
            font-size: 0.95rem;
        }

        #attendanceHistory .worker-row td:first-child {
            display: none;
        }

        #attendanceHistory .worker-row td:nth-child(2),
        #attendanceHistory .worker-row td:nth-child(3) {
            padding-left: 4vw;
        }

        #attendanceHistory .separator-row td {
            padding: 0.5vw 0;
        }

        #attendanceHistory .separator-row hr {
            border: none;
            border-top: 1px dashed var(--text-color);
            margin: 0.5vw 0;
        }

        .report-section h3 {
            font-size: 1.1rem;
            margin-bottom: 2vw;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-bg);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 3vw;
            border-radius: 1.5vw;
            width: 90%;
            max-width: 80vw;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            animation: slideUp 0.3s ease;
            z-index: 1001;
        }

        .close {
            position: absolute;
            top: 2vw;
            right: 2vw;
            font-size: 1.3rem;
            cursor: pointer;
            color: var(--text-color);
            transition: color 0.2s ease;
            z-index: 1002;
            pointer-events: auto;
        }

        .close:hover {
            color: var(--accent-color);
        }

        .search-filters {
            display: flex;
            flex-direction: column;
            gap: 2vw;
        }

        .date-range {
            display: flex;
            flex-direction: column;
            gap: 2vw;
        }

        #workerMessage, #attendanceMessage {
            margin-top: 2vw;
            font-size: 0.9rem;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(5vw); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        @keyframes loadingShine {
            100% { left: 200%; }
        }

        /* Mobile Breakpoints */
        @media (max-width: 480px) {
            h1 {
                font-size: 6vw;
            }

            .section {
                padding: 4vw;
            }

            button {
                padding: 2.5vw 5vw;
                font-size: 0.85rem;
            }

            input, select {
                padding: 2.5vw;
                font-size: 0.85rem;
            }

            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            #payReport th, #payReport td {
                padding: 3.5vw;
                font-size: 0.95rem;
            }

            #attendanceHistory .date-row td {
                font-size: 0.9rem;
            }

            .modal-content {
                width: 95%;
                max-width: 90vw;
                padding: 4vw;
            }
        }

        @media (min-width: 481px) and (max-width: 767px) {
            h1 {
                font-size: 5.5vw;
            }

            .section {
                padding: 3.5vw;
            }

            button {
                padding: 2.2vw 4.5vw;
                font-size: 0.9rem;
            }

            input, select {
                padding: 2.2vw;
                font-size: 0.9rem;
            }

            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            #payReport th, #payReport td {
                padding: 3.2vw;
                font-size: 0.98rem;
            }

            #attendanceHistory .date-row td {
                font-size: 0.92rem;
            }

            .modal-content {
                width: 92%;
                max-width: 85vw;
            }
        }

        @media (min-width: 768px) {
            body {
                padding: 3vw;
            }

            h1 {
                font-size: 2.2rem;
            }

            .section {
                padding: 3vw;
            }

            .search-filters, .date-range {
                flex-direction: row;
                gap: 2vw;
            }

            .bottom-nav {
                display: none;
            }

            .tab {
                display: flex;
                gap: 1.5vw;
                margin-bottom: 3vw;
            }

            .tab button {
                background: var(--card-bg);
                padding: 2vw 4vw;
                border-radius: 1vw;
                font-size: 0.95rem;
                font-weight: 500;
                color: var(--text-color);
                box-shadow: var(--shadow);
                border: 1px solid var(--border-color);
                z-index: 2;
                pointer-events: auto;
            }

            .tab button.active {
                background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
                color: var(--accent-color);
            }

            table {
                display: table;
                overflow-x: visible;
                white-space: normal;
            }

            #payReport th, #payReport td {
                padding: 15px;
                font-size: 1rem;
            }

            #attendanceHistory .date-row td {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <h1>WorkerSync</h1>

    <div class="tab">
        <button class="tablinks" onclick="openTab(event, 'manageWorkers')"><i class="fas fa-users"></i> Manage Workers</button>
        <button class="tablinks" onclick="openTab(event, 'updateAttendance')"><i class="fas fa-calendar-check"></i> Update Attendance</button>
        <button class="tablinks" onclick="openTab(event, 'viewReports')"><i class="fas fa-chart-bar"></i> View Reports</button>
    </div>

    <div id="manageWorkers" class="tabcontent section">
        <h2>Add/Update Worker</h2>
        <div class="form-group">
            <label for="workerName"><i class="fas fa-user"></i> Worker Name:</label>
            <input type="text" id="workerName" required>
        </div>
        <div class="form-group">
            <label for="payRate"><i class="fas fa-money-bill"></i> Daily Pay Rate:</label>
            <input type="number" id="payRate" required>
        </div>
        <button onclick="handleWorkerSubmit()"><i class="fas fa-save"></i> Submit</button>
        <div id="workerMessage"></div>

        <h2>Current Workers</h2>
        <table id="workersTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Pay Rate</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="workersList"></tbody>
        </table>
    </div>

    <div id="updateAttendance" class="tabcontent section">
        <h2>Update Attendance</h2>
        <div class="form-group">
            <label for="attendanceDate"><i class="fas fa-calendar"></i> Date:</label>
            <input type="date" id="attendanceDate" required>
        </div>
        <div id="attendanceFields"></div>
        <button onclick="submitAttendance()"><i class="fas fa-check"></i> Submit Attendance</button>
        <div id="attendanceMessage"></div>

        <h2>Correct Attendance</h2>
        <div class="search-filters">
            <input type="date" id="correctionDate" placeholder="Select date">
            <input type="text" id="searchWorker" placeholder="Search worker...">
        </div>
        <button onclick="searchAttendance()"><i class="fas fa-search"></i> Search</button>

        <table id="correctionTable">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Worker</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="correctionData"></tbody>
        </table>
    </div>

    <div id="viewReports" class="tabcontent section">
        <h2>Generate Reports</h2>
        <div class="date-range">
            <div class="form-group">
                <label for="startDate"><i class="fas fa-calendar-alt"></i> From:</label>
                <input type="date" id="startDate" required>
            </div>
            <div class="form-group">
                <label for="endDate"><i class="fas fa-calendar-alt"></i> To:</label>
                <input type="date" id="endDate" required>
            </div>
        </div>
        <button onclick="refreshReports()"><i class="fas fa-chart-line"></i> Generate Report</button>

        <div class="report-section">
            <h3>Pay Report</h3>
            <table id="payReport">
                <thead>
                    <tr>
                        <th>Worker Name</th>
                        <th>Total Days</th>
                        <th>Total Pay</th>
                    </tr>
                </thead>
                <tbody id="reportData"></tbody>
                <tfoot>
                    <tr id="totalRow">
                        <td colspan="2" style="text-align: right; font-weight: bold;">Total Amount:</td>
                        <td id="totalAmountCell" style="font-weight: bold;"></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="report-section">
            <h3>Attendance History</h3>
            <table id="attendanceHistory">
                <tbody id="attendanceHistoryData"></tbody>
            </table>
        </div>
    </div>

    <!-- Edit Attendance Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editModal')">&times;</span>
            <h4>Edit Attendance</h4>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Edit Worker Modal -->
    <div id="editWorkerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editWorkerModal')">&times;</span>
            <h4>Edit Worker</h4>
            <div id="workerModalContent"></div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <button class="tablinks" onclick="openTab(event, 'manageWorkers')"><i class="fas fa-users"></i> Workers</button>
        <button class="tablinks" onclick="openTab(event, 'updateAttendance')"><i class="fas fa-calendar-check"></i> Attendance</button>
        <button class="tablinks" onclick="openTab(event, 'viewReports')"><i class="fas fa-chart-bar"></i> Reports</button>
    </div>

    <script>
        let currentEditRecord = null;
        let currentEditWorker = null;

        // Load initial data
        document.addEventListener('DOMContentLoaded', function() {
            loadWorkers();
            loadAttendanceWorkers();
            openTab({ currentTarget: document.querySelector('.bottom-nav .tablinks') }, 'manageWorkers');
            const today = new Date();
            document.getElementById('startDate').value = formatDate(today);
            document.getElementById('endDate').value = formatDate(today);
        });

        function openTab(evt, tabName) {
            const tabcontent = document.getElementsByClassName("tabcontent");
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].classList.remove('active');
            }
            const tablinks = document.getElementsByClassName("tablinks");
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add("active");
        }

        function handleWorkerSubmit() {
            const button = event.currentTarget;
            button.classList.add('loading');
            const name = document.getElementById('workerName').value;
            const payRate = document.getElementById('payRate').value;

            google.script.run
                .withSuccessHandler(() => {
                    document.getElementById('workerMessage').innerHTML = 
                        '<p style="color: green;">Worker updated successfully!</p>';
                    loadWorkers();
                    loadAttendanceWorkers();
                    button.classList.remove('loading');
                })
                .withFailureHandler((error) => {
                    document.getElementById('workerMessage').innerHTML = 
                        `<p style="color: red;">Error: ${error.message}</p>`;
                    button.classList.remove('loading');
                })
                .addOrUpdateWorker(name, payRate);
        }

        function loadWorkers() {
            google.script.run
                .withSuccessHandler((workers) => {
                    const tbody = document.getElementById('workersList');
                    tbody.innerHTML = workers.map(worker => `
                        <tr>
                            <td>${worker[0]}</td>
                            <td>₹${worker[1]}</td>
                            <td>
                                <button class="edit-btn" onclick="openEditWorkerModal('${worker[0]}', ${worker[1]})" title="Edit Worker"><i class="fas fa-edit"></i></button>
                                <button class="delete-btn" onclick="deleteWorker('${worker[0]}')" title="Delete Worker"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `).join('');
                })
                .withFailureHandler(error => {
                    alert('Error loading workers: ' + error.message);
                })
                .getWorkers();
        }

        function openEditWorkerModal(name, payRate) {
            currentEditWorker = { originalName: name };
            const modalContent = `
                <div class="form-group">
                    <label><i class="fas fa-user"></i> Worker Name:</label>
                    <input type="text" id="editWorkerName" value="${name}">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-money-bill"></i> Daily Pay Rate:</label>
                    <input type="number" id="editPayRate" value="${payRate}">
                </div>
                <button onclick="saveWorkerChanges()"><i class="fas fa-save"></i> Save Changes</button>
            `;

            document.getElementById('workerModalContent').innerHTML = modalContent;
            document.getElementById('editWorkerModal').style.display = 'flex';
        }

        function saveWorkerChanges() {
            const button = event.currentTarget;
            button.classList.add('loading');
            const newName = document.getElementById('editWorkerName').value;
            const newPayRate = document.getElementById('editPayRate').value;

            google.script.run
                .withSuccessHandler(() => {
                    alert('Worker updated successfully!');
                    closeModal('editWorkerModal');
                    loadWorkers();
                    loadAttendanceWorkers();
                    button.classList.remove('loading');
                })
                .withFailureHandler(error => {
                    alert('Error: ' + error.message);
                    button.classList.remove('loading');
                })
                .editWorker(currentEditWorker.originalName, newName, newPayRate);
        }

        function deleteWorker(workerName) {
            const button = event.currentTarget;
            button.classList.add('loading');
            if (confirm(`Are you sure you want to delete worker ${workerName}? Their attendance records will remain.`)) {
                google.script.run
                    .withSuccessHandler(() => {
                        alert('Worker deleted successfully!');
                        loadWorkers();
                        loadAttendanceWorkers();
                        button.classList.remove('loading');
                    })
                    .withFailureHandler(error => {
                        alert('Error: ' + error.message);
                        button.classList.remove('loading');
                    })
                    .deleteWorker(workerName);
            } else {
                button.classList.remove('loading');
            }
        }

        function loadAttendanceWorkers() {
            google.script.run
                .withSuccessHandler((workers) => {
                    const container = document.getElementById('attendanceFields');
                    container.innerHTML = workers.map(worker => `
                        <div class="form-group">
                            <label>${worker}:</label>
                            <select class="attendance-select" data-worker="${worker}">
                                <option value="">-</option>
                                <option value="1.5">One And Half (1.5)</option>
                                <option value="1">Present (1.0)</option>
                                <option value="0.5">Half Day (0.5)</option>
                                <option value="0">Absent (0)</option>
                                <option value="2">Two Days (2.0)</option>
                            </select>
                        </div>
                    `).join('');
                })
                .withFailureHandler(error => {
                    alert('Error loading attendance workers: ' + error.message);
                })
                .getWorkerNames();
        }

        function submitAttendance() {
            const button = event.currentTarget;
            button.classList.add('loading');
            const dateInput = document.getElementById('attendanceDate').value;
            const dateObj = new Date(dateInput);

            if (isNaN(dateObj.getTime())) {
                alert('Invalid date format!');
                button.classList.remove('loading');
                return;
            }

            const attendanceData = {};
            document.querySelectorAll('.attendance-select').forEach(select => {
                attendanceData[select.dataset.worker] = select.value;
            });

            google.script.run
                .withSuccessHandler(() => {
                    document.getElementById('attendanceMessage').innerHTML = 
                        '<p style="color: green;">Attendance updated successfully!</p>';
                    button.classList.remove('loading');
                })
                .withFailureHandler(error => {
                    document.getElementById('attendanceMessage').innerHTML = 
                        `<p style="color: red;">Error: ${error.message}</p>`;
                    button.classList.remove('loading');
                })
                .updateAttendance(dateObj.toISOString().split('T')[0], attendanceData);
        }

        function isValidDate(d) {
            return d instanceof Date && !isNaN(d);
        }

        function searchAttendance() {
            const button = event.currentTarget;
            button.classList.add('loading');
            const date = document.getElementById('correctionDate').value;
            const worker = document.getElementById('searchWorker').value;

            google.script.run
                .withSuccessHandler(displayCorrectionData)
                .withFailureHandler(error => {
                    alert('Error searching attendance: ' + error.message);
                    button.classList.remove('loading');
                })
                .getAttendanceRecords(date, worker);
        }

        function displayCorrectionData(records) {
            const tbody = document.getElementById('correctionData');
            tbody.innerHTML = records.map(record => `
                <tr>
                    <td>${record.date}</td>
                    <td>${record.worker}</td>
                    <td>${getStatusText(record.status)}</td>
                    <td>
                        <button class="edit-btn" onclick="openEditModal('${record.date}', '${record.worker}', ${record.status})" title="Edit Attendance"><i class="fas fa-edit"></i></button>
                        <button class="delete-btn" onclick="deleteRecord('${record.date}', '${record.worker}')" title="Delete Attendance"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
            document.querySelector('.search-filters button').classList.remove('loading');
        }

        function openEditModal(date, worker, currentStatus) {
            currentEditRecord = { date, worker };
            const modalContent = `
                <p><strong>Date:</strong> ${date}</p>
                <p><strong>Worker:</strong> ${worker}</p>
                <div class="form-group">
                    <label>New Status:</label>
                    <select id="newStatus">
                        <option value="2" ${currentStatus == 2 ? 'selected' : ''}>Two Days</option>
                        <option value="1.5" ${currentStatus == 1.5 ? 'selected' : ''}>One and Half</option>
                        <option value="1" ${currentStatus == 1 ? 'selected' : ''}>Present</option>
                        <option value="0.5" ${currentStatus == 0.5 ? 'selected' : ''}>Half Day</option>
                        <option value="0" ${currentStatus == 0 ? 'selected' : ''}>Absent</option>
                    </select>
                </div>
                <button onclick="saveAttendanceChanges()"><i class="fas fa-save"></i> Save Changes</button>
            `;

            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('editModal').style.display = 'flex';
        }

        function saveAttendanceChanges() {
            const button = event.currentTarget;
            button.classList.add('loading');
            const newStatus = document.getElementById('newStatus').value;

            google.script.run
                .withSuccessHandler(() => {
                    alert('Attendance updated successfully!');
                    closeModal('editModal');
                    searchAttendance();
                    button.classList.remove('loading');
                })
                .withFailureHandler(error => {
                    alert('Error: ' + error.message);
                    button.classList.remove('loading');
                })
                .updateAttendanceRecord(currentEditRecord.date, currentEditRecord.worker, newStatus);
        }

        function deleteRecord(date, worker) {
            const button = event.currentTarget;
            button.classList.add('loading');
            if (confirm(`Are you sure you want to delete this record for ${worker} on ${date}?`)) {
                google.script.run
                    .withSuccessHandler(() => {
                        alert('Record deleted successfully!');
                        searchAttendance();
                        button.classList.remove('loading');
                    })
                    .withFailureHandler(error => {
                        alert('Error: ' + error.message);
                        button.classList.remove('loading');
                    })
                    .deleteAttendanceRecord(date, worker);
            } else {
                button.classList.remove('loading');
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'editModal') {
                currentEditRecord = null;
            } else if (modalId === 'editWorkerModal') {
                currentEditWorker = null;
            }
        }

        function refreshReports() {
            const button = event.currentTarget;
            button.classList.add('loading');
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                button.classList.remove('loading');
                return;
            }

            google.script.run
                .withSuccessHandler((data) => {
                    const reportBody = document.getElementById('reportData');
                    reportBody.innerHTML = '';
                    const totalAmountCell = document.getElementById('totalAmountCell');

                    if (data.error) {
                        reportBody.innerHTML = `<tr><td colspan="3">Error: ${data.error}</td></tr>`;
                        totalAmountCell.innerHTML = '';
                        button.classList.remove('loading');
                        return;
                    }

                    if (!data.reportData || data.reportData.length === 0) {
                        reportBody.innerHTML = '<tr><td colspan="3">No data found</td></tr>';
                        totalAmountCell.innerHTML = '';
                    } else {
                        data.reportData.forEach(row => {
                            reportBody.innerHTML += `
                                <tr>
                                    <td>${row.name}</td>
                                    <td>${row.days}</td>
                                    <td>₹${row.pay.toFixed(2)}</td>
                                </tr>
                            `;
                        });
                        totalAmountCell.innerHTML = `₹${data.totalAmount.toFixed(2)}`;
                    }

                    const historyBody = document.getElementById('attendanceHistoryData');
                    historyBody.innerHTML = '';

                    if (!data.attendanceHistory || data.attendanceHistory.length === 0) {
                        historyBody.innerHTML = '<tr><td colspan="3">No data found</td></tr>';
                    } else {
                        // Group attendance records by date
                        const groupedByDate = data.attendanceHistory.reduce((acc, entry) => {
                            if (!acc[entry.date]) {
                                acc[entry.date] = [];
                            }
                            acc[entry.date].push(entry);
                            return acc;
                        }, {});

                        // Sort dates in ascending order
                        const sortedDates = Object.keys(groupedByDate).sort((a, b) => new Date(a) - new Date(b));

                        // Generate table rows
                        sortedDates.forEach(date => {
                            historyBody.innerHTML += `
                                <tr class="date-row">
                                    <td colspan="3">${date}</td>
                                </tr>
                            `;
                            groupedByDate[date].forEach(entry => {
                                historyBody.innerHTML += `
                                    <tr class="worker-row">
                                        <td></td>
                                        <td>${entry.worker}</td>
                                        <td>${getStatusText(entry.status)}</td>
                                    </tr>
                                `;
                            });
                            historyBody.innerHTML += `
                                <tr class="separator-row">
                                    <td colspan="3"><hr></td>
                                </tr>
                            `;
                        });
                    }

                    document.getElementById('totalRow').style.display = data.reportData.length > 0 ? 'table-row' : 'none';
                    button.classList.remove('loading');
                })
                .withFailureHandler(error => {
                    alert('Error generating report: ' + error.message);
                    document.getElementById('reportData').innerHTML = '<tr><td colspan="3">Error generating report</td></tr>';
                    document.getElementById('totalAmountCell').innerHTML = '';
                    document.getElementById('totalRow').style.display = 'none';
                    button.classList.remove('loading');
                })
                .calculateTotalPay(startDate, endDate);
        }

        function getStatusText(status) {
            const statusMap = {
                '0': 'Absent',
                '0.5': 'Half Day',
                '1': 'Present',
                '1.5': 'One and Half',
                '2': 'Two Days'
            };
            return statusMap[status] || 'Unknown';
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }
    </script>
</body>
</html>
